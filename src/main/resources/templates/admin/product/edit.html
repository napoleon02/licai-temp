<form id="editProduct_form" class="form-container" enctype="multipart/form-data">
    <div class="form-row" style="overflow:hidden;">
        <div class="mianbox" style="overflow:hidden;">
            <div class="'leftBox" style="float:left;width:50%;">
                <p>
                    <span class="title">产品名称:</span>
                    <input class="easyui-textbox" name="name"
                           required="true"
                           value="${bean.name!}"
                           data-options="prompt:'',validType:'length[0,50]'" style="width:300px;">
                </p>
                <p>
                    <span class="title">产品期限单位：</span>
                    <select class="easyui-combobox unit" name="unit" editable="false" style="width:50px;">
                        <option value="DAY" ${bean.unit! == 'DAY' ? 'selected' : ''}>日</option>
                        <option value="MONTH" ${bean.unit! == 'MONTH' ? 'selected' : ''}>月</option>
                        <option value="YEAR" ${bean.unit! == 'YEAR' ? 'selected' : ''}>年</option>
                    </select>
                    <input class="easyui-numberbox limit" label="产品期限" name="limit"
                           required="true"
                           value="${bean.limit!}"
                           data-options="prompt:''" style="width:200px;margin-bottom:10px;">
                </p>
                <p>
                    <span class="title">产品总金额:</span>
                    <input class="easyui-numberbox amount" name="amount"
                           required="true"
                           value="${bean.amount!}"
                           data-options="prompt:''" style="width:300px;">
                </p>
                <p>
                    <span class="title">预期年化收益率%:</span>
                    <input class="easyui-numberbox" name="apr"
                           required="true"
                           value="${bean.apr!}"
                           data-options="precision:2" style="width:300px;">
                </p>
                <p>
                    <span class="title">最小投资单位:</span>
                    <input class="easyui-numberbox minUnit" name="minUnit"
                           required="true"
                           value="${bean.minUnit!}"
                           data-options="prompt:''" style="width:300px;">
                </p>
                <p>
                    <span class="title">最小投资金额:</span>
                    <input class="easyui-numberbox minAmount" name="minAmount"
                           required="true"
                           value="${bean.minAmount!}"
                           data-options="prompt:''" style="width:300px;">
                </p>
                <p>
                    <span class="title">最大购买金额:</span>
                    <input class="easyui-numberbox maxAmount" name="maxAmount"
                           required="true"
                           value="${bean.maxAmount!}"
                           data-options="prompt:''" style="width:300px;">
                </p>
                <p>
                    <span class="title">投标开始时间:</span>
                    <input class="easyui-datetimebox" name="bidBeginDate"
                           required="true"
                           value="${bean.bidBeginDate!,'yyyy-MM-dd HH:mm:ss'}}"
                           data-options="prompt:''" style="width:300px;" editable="false" id="check1">
                </p>
                <p>
                    <span class="title">投标结束时间:</span>
                    <input class="easyui-datetimebox bidEndDate" name="bidEndDate"
                           required="true"
                           value="${bean.bidEndDate!,'yyyy-MM-dd HH:mm:ss'}}"
                           data-options="prompt:''" style="width:300px;" editable="false" id="check2">
                </p>
                <p>
                    <span class="title">起息日类型:</span>
                    <select class="easyui-combobox" id="startDay" name="startType" editable="false" style="width:100px;">
                        <option value="DIRECT" ${bean.startType! == 'DIRECT' ? 'selected' : ''}>指定</option>
                        <!--<option value="T+1" ${bean.startType! == 'T+1' ? 'selected' : ''}>T+1</option>
                        <option value="T+2" ${bean.startType! == 'T+2' ? 'selected' : ''}>T+2</option>
                        <option value="T+3" ${bean.startType! == 'T+3' ? 'selected' : ''}>T+3</option>-->
                    </select>
                </p>
                <p class="startDayBox">
                    <span class="title">起息日:</span>
                    <input class="easyui-datetimebox startDay" name="startDay"
                           required="false"
                           value="${bean.startDay!,'yyyy-MM-dd HH:mm:ss'}}"
                           data-options="prompt:''" style="width:300px;" editable="false" id="check3">
                </p>
                <p>
                    <span class="title">计息结束时间:</span>
                    <input class="easyui-datetimebox countOverDate" name="countOverDate"
                           required="true"
                           value="${bean.countOverDate!,'yyyy-MM-dd HH:mm:ss'}}"
                           data-options="prompt:''" style="width:300px;" editable="false" id="check4">
                </p>
                <p>
                    <span class="title">预计到账时间：</span>
                    <input class="easyui-datetimebox planDate" name="planDate"
                           required="true"
                           value="${bean.planDate!,'yyyy-MM-dd HH:mm:ss'}}"
                           data-options="prompt:''" style="width:200px;" editable="false" id="check5">
                </p>
                <p>
                    <span class="title">是否提前结束：</span>
                    <select class="easyui-combobox" name="isEarlyEnd" editable="false" style="width:50px;">
                        <option value="N" ${bean.isEarlyEnd! == 'N' ? 'selected' : ''}>否</option>
                        <option value="Y" ${bean.isEarlyEnd! == 'Y' ? 'selected' : ''}>是</option>
                    </select>
                </p>
                <p>
                    <span class="title">收益说明:</span>
                    <input class="easyui-textbox" name="incomeDesc"
                           required="true"
                           value="${bean.incomeDesc!}"
                           data-options="prompt:''" style="width:300px;">
                </p>
                <p>
                    <span class="title">收益支付方式:</span>
                    <select class="easyui-combobox" name="incomeMode" editable="false" style="width:200px;">
                        <option value="EXPIRE" ${bean.incomeMode! == 'EXPIRE' ? 'selected' : ''}>到期后本息一次性支付</option>
                        <option value="DAY" ${bean.incomeMode! == 'DAY' ? 'selected' : ''}>日结</option>
                        <option value="MONTH" ${bean.incomeMode! == 'MONTH' ? 'selected' : ''}>月结</option>
                        <option value="YEAR" ${bean.incomeMode! == 'YEAR' ? 'selected' : ''}>年结</option>
                    </select>
                </p>
            </div>
        </div>
        <p>
            <span class="title" style="display:block;margin-bottom:8px;">退出费用说明:</span>
            <textarea class="easyui-textbox" name="exitFeeDesc"
                      required="true"
                      multiline="true"
                      data-options="prompt:''" style="width:500px;height:80px;">${bean.exitFeeDesc!}</textarea>
        </p>
        <p>
            <span class="title" style="display:block;margin-bottom:8px;">购买费用说明:</span>
            <textarea class="easyui-textbox" name="buyFeeDesc"
                      required="true"
                      multiline="true"
                      data-options="prompt:''" style="width:500px;height:80px;">${bean.buyFeeDesc!}</textarea>
        </p>
        <p>
            <span class="title" style="display:block;margin-bottom:8px;">资金用途:</span>
            <textarea class="easyui-textbox" name="capitalDesc"
                      required="true"
                      multiline="true"
                      data-options="prompt:'',validType:'length[0,200]'" style="width:500px;height:80px;">${bean.capitalDesc!}</textarea>
        </p>
        <p>
            <span class="title" style="display:block;margin-bottom:8px;">资产渠道方:</span>
            <textarea class="easyui-textbox" name="assetsChannel"
                      required="true"
                      multiline="true"
                      data-options="prompt:'',validType:'length[0,200]'" style="width:500px;height:80px;">${bean.assetsChannel!}</textarea>
        </p>
        <p>
            <span class="title" style="display:block;margin-bottom:8px;">资产详情:</span>
            <textarea class="easyui-textbox" name="assetsInfo"
                      required="true"
                      multiline="true"
                      data-options="prompt:'',validType:'length[0,200]'" style="width:500px;height:80px;">${bean.assetsInfo!}</textarea>
        </p>
        <p>
            <span class="title" style="display:block;margin-bottom:8px;">还款来源:</span>
            <textarea class="easyui-textbox" name="repaySource"
                      required="true"
                      multiline="true"
                      data-options="prompt:'',validType:'length[0,200]'" style="width:500px;height:80px;">${bean.repaySource!}</textarea>
        </p>
        <p>
            <span class="title" style="display:block;margin-bottom:8px;">风险措施:</span>
            <textarea class="easyui-textbox" name="riskMeasures"
                      required="true"
                      multiline="true"
                      data-options="prompt:'',validType:'length[0,200]'" style="width:500px;height:80px;">${bean.riskMeasures!}</textarea>
        </p>
        <p>
            <span style="display:block;margin-bottom:8px;">产品介绍：</span>
            <textarea class="easyui-textbox" name="productDesc"
                      required="true"
                      multiline="true"
                      data-options="multiline:true,validType:'length[0,2048]'" style="width:500px;height:200px">${bean.productDesc!}</textarea>
        </p>
        <p>
            <span class="title">协议名称:</span>
            <input class="easyui-textbox" name="protocolName"
                   required="true"
                   value="${bean.protocolName!}"
                   data-options="prompt:'',validType:'length[0,30]'" style="width:500px;">
        </p>
        <div style="margin-bottom:20px">
            <span class="title">协议文件:</span>
            <input class="easyui-filebox" accept=".pdf"
                   name="file"
                   data-options="prompt:'',buttonText:'选择文件'" style="width:500px;">
        </div>
        <div class="form-row">
            <label>协议文件名称： ${bean.protocolName!}</label>
            <a href="/admin/product/downloadProductProtocolFile?id=${bean.id}" target="_blank">点击下载协议文件</a>
        </div>
    </div>
    <div class="form-footer">
        <button type="button" class="easyui-linkbutton btn" data-options="iconCls:'icon-save',width:'80px'" id="editProduct_confirm">确认</button>
        <button type="button" class="easyui-linkbutton btn" data-options="iconCls:'icon-cancel',width:'80px'" id="editProduct_cancel">取消</button>
    </div>
    <input type="hidden" name="id" value="${bean.id}">
</form>
<style>
    #editProduct_form p {
        margin: 5px 0 10px 0;
    }

    #editProduct_form .title {
        width: 100px;
        display: inline-block;
    }

    #editProduct_form .textbox-icon {
        float: right;
    }

    #editProduct_form .combo-panel {
        height: auto;
    }

</style>
<script>

    $(function(){
        // 这是只允许选择当前时间之后的时间
        $("#check1").datetimebox('calendar').calendar({
            validator: function(date){
                return validator(date);
            }
        });

        $("#check2").datetimebox('calendar').calendar({
            validator: function(date){
                return validator(date);
            }
        });

        $("#check3").datetimebox('calendar').calendar({
            validator: function(date){
                return validator(date);
            }
        });

        $("#check4").datetimebox('calendar').calendar({
            validator: function(date){
                return validator(date);
            }
        });

        $("#check5").datetimebox('calendar').calendar({
            validator: function(date){
                return validator(date);
            }
        });
    });

    function validator(date){
        var now = new Date();
        var d1 = new Date(now.getFullYear(), now.getMonth(), now.getDate()-1,now.getHours(),now.getMinutes(),now.getSeconds());
        return date>=d1;
    }


    $(function () {
        var bad = true;
        $("#editProduct_form").form("disableValidation");

        $("#editProduct_cancel").on("click", function () {
            var tab = $('#main-tabs').tabs('getSelected');
            if (tab) {
                var index = $('#main-tabs').tabs('getTabIndex', tab);
                if (index > 0) {
                    $('#main-tabs').tabs("close", index);
                }
            }
        });

        $("#editProduct_confirm").on("click", function () {
            $.messager.confirm('提示', '确定要保存编辑的产品?', function (res) {
                submit("/admin/product/editProduct");
            });
        });

        // 起息日选择
        $("#editProduct_form").find('#startDay').combobox({
            onSelect: function (record) {
                if (record.value == "DIRECT") {
                    $('.startDayBox').css({"display": "block"});
                    // $(".startDay").datetimebox("setValue", "");
                } else {
                    $('.startDayBox').css({"display": "none"});
                    $(".startDay").datetimebox("setValue", "2008-08-08 00:00:00");
                }
            }

        });
        // 计息结束时间
        /*$(".bidEndDate").datetimebox({
            onChange: function (value) {
                // console.log($(".bidEndDate").datebox('getValue'))
                // console.log(11+$(".countOverDate").datebox('getValue'))
                if ($(".unit").combobox("getValue") == "DAY") {
                    var endDay = new Date($(".bidEndDate").datebox('getValue')).getTime();
                    var addDay = $(".limit").numberbox("getValue") * 1 * 24 * 60 * 60 * 1000;
                    var overDay = new Date((endDay + addDay));
                    $(".countOverDate").datetimebox("setValue", formatter(overDay));
                    // $(".countOverDate").val(formatter(overDay));
                } else if ($(".unit").combobox("getValue") == "MONTH") {
                    var endDay = new Date($(".bidEndDate").datebox('getValue')).getTime();
                    var addDay = $(".limit").numberbox("getValue") * 1 * 24 * 60 * 60 * 1000 * 30;
                    var overDay = new Date((endDay + addDay));
                    $(".countOverDate").datetimebox("setValue", formatter(overDay));
                } else if ($(".unit").combobox("getValue") == "YEAR") {
                    var endDay = new Date($(".bidEndDate").datebox('getValue')).getTime();
                    var addDay = $(".limit").numberbox("getValue") * 1 * 24 * 60 * 60 * 1000 * 365;
                    var overDay = new Date((endDay + addDay));
                    $(".countOverDate").datetimebox("setValue", formatter(overDay));
                }
            }
        });*/

        $(".textbox-invalid").css({"background": "#ffffff", "border-color": "#95B8E7"});
        $(".validatebox-invalid").css({"background": "#ffffff"});

        // 预计到账时间
        $(".type").combobox({
            onChange: function (value) {
                console.log($(".type").combobox('getValue'));
                if ($(".type").combobox("getValue") == "T+1") {
                    console.log(1)
                    var endDay = $(".countOverDate").datebox('getValue');
                    console.log(endDay)
                    var overDay = getworkday(endDay, 1);
                    $(".planDate").datetimebox("setValue", overDay);
                } else if ($(".type").combobox("getValue") == "T+2") {
                    console.log(2)
                    var endDay = $(".countOverDate").datebox('getValue');
                    var overDay = getworkday(endDay, 2);
                    $(".planDate").datetimebox("setValue", overDay);
                } else if ($(".type").combobox("getValue") == "T+3") {
                    console.log(3)
                    var endDay = $(".countOverDate").datebox('getValue');
                    var overDay = getworkday(endDay, 3);
                    $(".planDate").datetimebox("setValue", overDay);
                }
            }
        });

        // 工作日计算
        function getworkday(date, itervalByDay) {
            var date1 = new Date(date);
            console.log(date1)
            var millisceonds = date1.getTime();
            for (var i = 1; i <= itervalByDay; i++) {
                millisceonds += 24 * 60 * 60 * 1000;
                date1.setTime(millisceonds);
                console.log("------" + i);
                /*  if (date1.getDay() === 0 || date1.getDay() === 6) {
                      i--
                      console.log("--里面----" + i);
                  }*/
            }
            var Y = date1.getFullYear() + '-';
            var M = (date1.getMonth() + 1 < 10 ? '0' + (date1.getMonth() + 1) : date1.getMonth() + 1) + '-';
            var D = (date1.getDate() < 10 ? '0' + (date1.getDate()) : date1.getDate()) + ' ';
            var H = (date1.getHours() < 10 ? '0' + (date1.getHours()) : date1.getHours()) + ':';
            var MIN = (date1.getMinutes() < 10 ? '0' + (date1.getMinutes()) : date1.getMinutes()) + ':';
            var S = (date1.getSeconds() < 10 ? '0' + (date1.getSeconds()) : date1.getSeconds());
            return Y + M + D + H + MIN + S
        }

        // 时间格式转换
        function formatter(date) {
            return date.getFullYear() + '-' + getzf((date.getMonth() + 1)) + '-' + getzf(date.getDate()) + ' ' + getzf(date.getHours()) + ':' + getzf(date.getMinutes()) + ':' + getzf(date.getSeconds())
        }

        // 时间补零操作
        function getzf(num) {
            if (parseInt(num) < 10) {
                num = '0' + num;
            }
            return num;
        }

        //验证
        $("input", $(".maxAmount").next("span")).blur(function () {
            if ($(".maxAmount").val() * 1 < $(".minAmount").val() * 1) {
                $.messager.alert('提示', '必须大于最小投资金额')
                $(".maxAmount").textbox('setValue', '')//赋值
            } else if ($(".maxAmount").val() * 1 % ($(".minUnit").val() * 1) != 0) {
                $.messager.alert('提示', '最大购买金额必须是最小投资单位的整数倍')
                $(".maxAmount").textbox('setValue', '')//赋值
            } else if ($(".maxAmount").val() * 1 > $(".amount").val() * 1) {
                $.messager.alert('提示', '最大购买金额必须小于产品总金额')
                $(".maxAmount").textbox('setValue', '')//赋值
            }
        });
        $("input", $(".minAmount").next("span")).blur(function () {
            if ($(".minUnit").val() * 1 > $(".minAmount").val() * 1) {
                $.messager.alert('提示', '必须大于最小投资单位')
                $(".minAmount").textbox('setValue', '')//赋值
            } else if ($(".minAmount").val() * 1 % ($(".minUnit").val() * 1) != 0) {
                $.messager.alert('提示', '最小购买金额必须是最小投资单位的整数倍')
                $(".minAmount").textbox('setValue', '')//赋值
            } else if ($(".minAmount").val() * 1 > $(".amount").val() * 1) {
                $.messager.alert('提示', '最小购买金额必须小于产品总金额')
                $(".minAmount").textbox('setValue', '')//赋值
            }
        });
        $("input", $(".minUnit").next("span")).blur(function () {
            if ($(".minUnit").val() * 1 > $(".amount").val() * 1) {
                $.messager.alert('提示', '最小投资单位必须小于产品总金额')
                $(".minAmount").textbox('setValue', '')//赋值
            }
        });

        function submit(url) {
            var r = $("#editProduct_form").form('enableValidation').form('validate');
            if (r && bad) {
                bad = false;
                $("#editProduct_form").ajaxSubmit({
                    url: url,
                    type: "post",
                    dataType: "json",
                    success: function (data) {
                        if (data.success) {
                            showMsg(data.msg, 1, function () {
                                var tab = $('#main-tabs').tabs('getSelected');
                                tab.panel('refresh');
                            });
                        } else {
                            showMsg(data.msg, 4);
                            bad = true;
                        }
                    }
                });
            }
        }
    });
</script>